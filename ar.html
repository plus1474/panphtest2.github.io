<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARカメラ</title>
    
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-ar/dist/aframe-ar.min.js"></script>
    
    <style>
        /* スタイルの初期化 */
        body { margin: 0; overflow: hidden; }
        
        /* UI要素の配置とz-indexの調整 */
        
        /* 1. 戻るボタンのスタイル */
        #backBtn {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 10px 15px;
            background: rgba(0,0,0,0.6);
            color: white;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            z-index: 1001;
        }

        /* 2. 撮影ボタンのスタイル */
        #captureBtn {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: red;
            border: 5px solid rgba(255, 255, 255, 0.8);
            cursor: pointer;
            z-index: 1001;
        }

        /* 3. ARシーンの調整 */
        a-scene {
            z-index: 1; 
            position: absolute !important;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* 4. キャプチャ画像表示エリアのスタイル */
        #capturedImageContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 2000; /* 最前面 */
        }
        #capturedImage {
            max-width: 90%;
            max-height: 90%;
            display: block;
            border: 2px solid white;
        }
        #closeBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 2001;
        }
    </style>
</head>
<body>
    <a id="backBtn" href="index.html">← 戻る</a>

    <button id="captureBtn" aria-label="写真を撮影"></button>

    <div id="capturedImageContainer">
        <img id="capturedImage" alt="撮影された写真" title="画像を長押し（または右クリック）で保存できます。">
        <button id="closeBtn">閉じる</button>
    </div>

    <a-scene 
        embedded 
        arjs='sourceType: webcam; videoTextureParameters: { facingMode: environment, maxResolution: { width: 1280, height: 720 } };'
        >
        
        <a-assets>
            <a-asset-item id="blender-model" src="model.glb"></a-asset-item>
        </a-assets>

        <a-marker type="pattern" url="pattern-marker.patt">
            <a-entity
                gltf-model="#blender-model"
                position="0 0 0" 
                rotation="0 0 0" 
                scale="1 1 1">
            </a-entity>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const scene = document.querySelector('a-scene');
            const captureBtn = document.getElementById('captureBtn');
            const container = document.getElementById('capturedImageContainer');
            const image = document.getElementById('capturedImage');
            const closeBtn = document.getElementById('closeBtn');

            captureBtn.addEventListener('click', function() {
                // AR.jsのビデオ要素と3D Canvasを取得
                const video = document.querySelector('video');
                const canvas3D = scene.canvas;
                
                // 初期化チェック
                if (!video || !canvas3D || video.readyState < 2) {
                    console.error("Video or Canvas element not found or not ready.");
                    alert("カメラの初期化が完了していません。マーカーを認識させる準備ができてから、再度お試しください。");
                    return;
                }

                // 1. 一時的な新しいCanvasを作成し、ビデオの本来の解像度で設定
                const captureCanvas = document.createElement('canvas');
                captureCanvas.width = video.videoWidth;
                captureCanvas.height = video.videoHeight;
                const ctx = captureCanvas.getContext('2d');

                // 2. ビデオ映像を描画
                ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
                
                // 3. 3Dシーン（ARオブジェクト）をビデオの上に重ねて描画
                ctx.drawImage(canvas3D, 0, 0, canvas3D.width, canvas3D.height, 0, 0, video.videoWidth, video.videoHeight);

                // 4. データを取得
                // サーバー環境での利用を想定し、セキュリティリスクの少ないPNG形式で取得
                try {
                    const dataURL = captureCanvas.toDataURL('image/png');
                    // 5. 画像を表示
                    image.src = dataURL;
                    container.style.display = 'flex';
                } catch (e) {
                    console.error("Canvas export failed (security error, likely cross-origin content):", e);
                    alert("キャプチャに失敗しました。GLBファイルやマーカーパターンファイルが現在のGitHub Pagesと同じサーバーにあるか確認してください。");
                }
            });

            // 閉じる処理
            closeBtn.addEventListener('click', function() {
                container.style.display = 'none';
                image.src = '';
            });
        });
    </script>
</body>
</html>
